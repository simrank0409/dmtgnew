!function (e, t) { "object" == typeof exports && "undefined" != typeof module ? module.exports = t() : "function" == typeof define && define.amd ? define(t) : (e = e || self).Compressor = t() }(this, function () { "use strict"; function e(e, t) { for (var r = 0; r < t.length; r++) { var a = t[r]; a.enumerable = a.enumerable || !1, a.configurable = !0, "value" in a && (a.writable = !0), Object.defineProperty(e, a.key, a) } } function t(e, t, r) { return t in e ? Object.defineProperty(e, t, { value: r, enumerable: !0, configurable: !0, writable: !0 }) : e[t] = r, e } function r() { return (r = Object.assign || function (e) { for (var t = 1; t < arguments.length; t++) { var r = arguments[t]; for (var a in r) Object.prototype.hasOwnProperty.call(r, a) && (e[a] = r[a]) } return e }).apply(this, arguments) } function a(e, t) { var r = Object.keys(e); if (Object.getOwnPropertySymbols) { var a = Object.getOwnPropertySymbols(e); t && (a = a.filter(function (t) { return Object.getOwnPropertyDescriptor(e, t).enumerable })), r.push.apply(r, a) } return r } function i(e) { for (var r = 1; r < arguments.length; r++) { var i = null != arguments[r] ? arguments[r] : {}; r % 2 ? a(Object(i), !0).forEach(function (r) { t(e, r, i[r]) }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(i)) : a(Object(i)).forEach(function (t) { Object.defineProperty(e, t, Object.getOwnPropertyDescriptor(i, t)) }) } return e } var n, o = (function (e) { "undefined" != typeof window && function (t) { var r = t.HTMLCanvasElement && t.HTMLCanvasElement.prototype, a = t.Blob && function () { try { return Boolean(new Blob) } catch (e) { return !1 } }(), i = a && t.Uint8Array && function () { try { return 100 === new Blob([new Uint8Array(100)]).size } catch (e) { return !1 } }(), n = t.BlobBuilder || t.WebKitBlobBuilder || t.MozBlobBuilder || t.MSBlobBuilder, o = /^data:((.*?)(;charset=.*?)?)(;base64)?,/, l = (a || n) && t.atob && t.ArrayBuffer && t.Uint8Array && function (e) { var t, r, l, s, c, u, f, h, d; if (!(t = e.match(o))) throw new Error("invalid data URI"); for (r = t[2] ? t[1] : "text/plain" + (t[3] || ";charset=US-ASCII"), l = !!t[4], s = e.slice(t[0].length), c = l ? atob(s) : decodeURIComponent(s), u = new ArrayBuffer(c.length), f = new Uint8Array(u), h = 0; h < c.length; h += 1)f[h] = c.charCodeAt(h); return a ? new Blob([i ? f : u], { type: r }) : ((d = new n).append(u), d.getBlob(r)) }; t.HTMLCanvasElement && !r.toBlob && (r.mozGetAsFile ? r.toBlob = function (e, t, a) { var i = this; setTimeout(function () { a && r.toDataURL && l ? e(l(i.toDataURL(t, a))) : e(i.mozGetAsFile("blob", t)) }) } : r.toDataURL && l && (r.toBlob = function (e, t, r) { var a = this; setTimeout(function () { e(l(a.toDataURL(t, r))) }) })), e.exports ? e.exports = l : t.dataURLtoBlob = l }(window) }(n = { exports: {} }, n.exports), n.exports), l = { strict: !0, checkOrientation: !0, maxWidth: 1 / 0, maxHeight: 1 / 0, minWidth: 0, minHeight: 0, width: void 0, height: void 0, quality: .8, mimeType: "auto", convertSize: 5e6, beforeDraw: null, drew: null, success: null, error: null }, s = "undefined" != typeof window && void 0 !== window.document ? window : {}, c = Array.prototype.slice; var u = /^image\/.+$/; function f(e) { return u.test(e) } var h = String.fromCharCode; var d = s.btoa; function b(e) { var t, r = new DataView(e); try { var a, i, n; if (255 === r.getUint8(0) && 216 === r.getUint8(1)) for (var o = r.byteLength, l = 2; l + 1 < o;) { if (255 === r.getUint8(l) && 225 === r.getUint8(l + 1)) { i = l; break } l += 1 } if (i) { var s = i + 10; if ("Exif" === function (e, t, r) { var a, i = ""; for (r += t, a = t; a < r; a += 1)i += h(e.getUint8(a)); return i }(r, i + 4, 4)) { var c = r.getUint16(s); if (((a = 18761 === c) || 19789 === c) && 42 === r.getUint16(s + 2, a)) { var u = r.getUint32(s + 4, a); u >= 8 && (n = s + u) } } } if (n) { var f, d, b = r.getUint16(n, a); for (d = 0; d < b; d += 1)if (f = n + 12 * d + 2, 274 === r.getUint16(f, a)) { f += 8, t = r.getUint16(f, a), r.setUint16(f, 1, a); break } } } catch (e) { t = 1 } return t } var m = /\.\d*(?:0|9){12}\d*$/; function p(e) { var t = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : 1e11; return m.test(e) ? Math.round(e * t) / t : e } var g = s.ArrayBuffer, v = s.FileReader, y = s.URL || s.webkitURL, w = /\.\w+$/, O = s.Compressor; return function () { function t(e, r) { !function (e, t) { if (!(e instanceof t)) throw new TypeError("Cannot call a class as a function") }(this, t), this.file = e, this.image = new Image, this.options = i({}, l, {}, r), this.aborted = !1, this.result = null, this.init() } var a, n, u; return a = t, u = [{ key: "noConflict", value: function () { return window.Compressor = O, t } }, { key: "setDefaults", value: function (e) { r(l, e) } }], (n = [{ key: "init", value: function () { var e = this, t = this.file, a = this.options; if (i = t, "undefined" != typeof Blob && (i instanceof Blob || "[object Blob]" === Object.prototype.toString.call(i))) { var i, n = t.type; if (y && v) if (g || (a.checkOrientation = !1), y && !a.checkOrientation) this.load({ url: y.createObjectURL(t) }); else { var o = new v, l = a.checkOrientation && "image/jpeg" === n; this.reader = o, o.onload = function (a) { var i = a.target.result, o = {}; if (l) { var s = b(i); s > 1 || !y ? (o.url = function (e, t) { for (var r, a = [], i = new Uint8Array(e); i.length > 0;)a.push(h.apply(null, (r = i.subarray(0, 8192), Array.from ? Array.from(r) : c.call(r)))), i = i.subarray(8192); return "data:".concat(t, ";base64,").concat(d(a.join(""))) }(i, n), s > 1 && r(o, function (e) { var t = 0, r = 1, a = 1; switch (e) { case 2: r = -1; break; case 3: t = -180; break; case 4: a = -1; break; case 5: t = 90, a = -1; break; case 6: t = 90; break; case 7: t = 90, r = -1; break; case 8: t = -90 }return { rotate: t, scaleX: r, scaleY: a } }(s))) : o.url = y.createObjectURL(t) } else o.url = i; e.load(o) }, o.onabort = function () { e.fail(new Error("Aborted to read the image with FileReader.")) }, o.onerror = function () { e.fail(new Error("Failed to read the image with FileReader.")) }, o.onloadend = function () { e.reader = null }, l ? o.readAsArrayBuffer(t) : o.readAsDataURL(t) } else this.fail(new Error("The current browser does not support image compression.")) } else this.fail(new Error("The first argument must be a File or Blob object.")) } }, { key: "load", value: function (e) { var t = this, r = this.file, a = this.image; a.onload = function () { t.draw(i({}, e, { naturalWidth: a.naturalWidth, naturalHeight: a.naturalHeight })) }, a.onabort = function () { t.fail(new Error("Aborted to load the image.")) }, s.navigator && /(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(s.navigator.userAgent) && (a.crossOrigin = "anonymous"), a.alt = r.name, a.src = e.url } }, { key: "draw", value: function (e) { var t = this, r = e.naturalWidth, a = e.naturalHeight, i = e.rotate, n = void 0 === i ? 0 : i, l = e.scaleX, s = void 0 === l ? 1 : l, c = e.scaleY, u = void 0 === c ? 1 : c, h = this.file, d = this.image, b = this.options, m = document.createElement("canvas"), g = m.getContext("2d"), v = r / a, y = Math.abs(n) % 180 == 90, w = Math.max(b.maxWidth, 0) || 1 / 0, O = Math.max(b.maxHeight, 0) || 1 / 0, U = Math.max(b.minWidth, 0) || 0, B = Math.max(b.minHeight, 0) || 0, j = Math.max(b.width, 0) || r, k = Math.max(b.height, 0) || a; if (y) { var x = [O, w]; w = x[0], O = x[1]; var A = [B, U]; U = A[0], B = A[1]; var M = [k, j]; j = M[0], k = M[1] } w < 1 / 0 && O < 1 / 0 ? O * v > w ? O = w / v : w = O * v : w < 1 / 0 ? O = w / v : O < 1 / 0 && (w = O * v), U > 0 && B > 0 ? B * v > U ? B = U / v : U = B * v : U > 0 ? B = U / v : B > 0 && (U = B * v), k * v > j ? k = j / v : j = k * v; var R = -(j = Math.floor(p(Math.min(Math.max(j, U), w)))) / 2, T = -(k = Math.floor(p(Math.min(Math.max(k, B), O)))) / 2, D = j, L = k; if (y) { var E = [k, j]; j = E[0], k = E[1] } m.width = j, m.height = k, f(b.mimeType) || (b.mimeType = h.type); var P = "transparent"; if (h.size > b.convertSize && "image/png" === b.mimeType && (P = "#fff", b.mimeType = "image/jpeg"), g.fillStyle = P, g.fillRect(0, 0, j, k), b.beforeDraw && b.beforeDraw.call(this, g, m), !this.aborted && (g.save(), g.translate(j / 2, k / 2), g.rotate(n * Math.PI / 180), g.scale(s, u), g.drawImage(d, R, T, D, L), g.restore(), b.drew && b.drew.call(this, g, m), !this.aborted)) { var C = function (e) { t.aborted || t.done({ naturalWidth: r, naturalHeight: a, result: e }) }; m.toBlob ? m.toBlob(C, b.mimeType, b.quality) : C(o(m.toDataURL(b.mimeType, b.quality))) } } }, { key: "done", value: function (e) { var t, r, a = e.naturalWidth, i = e.naturalHeight, n = e.result, o = this.file, l = this.image, s = this.options; if (y && !s.checkOrientation && y.revokeObjectURL(l.src), n) if (s.strict && n.size > o.size && s.mimeType === o.type && !(s.width > a || s.height > i || s.minWidth > a || s.minHeight > i)) n = o; else { var c = new Date; n.lastModified = c.getTime(), n.lastModifiedDate = c, n.name = o.name, n.name && n.type !== o.type && (n.name = n.name.replace(w, (t = n.type, "jpeg" === (r = f(t) ? t.substr(6) : "") && (r = "jpg"), ".".concat(r)))) } else n = o; this.result = n, s.success && s.success.call(this, n) } }, { key: "fail", value: function (e) { var t = this.options; if (!t.error) throw e; t.error.call(this, e) } }, { key: "abort", value: function () { this.aborted || (this.aborted = !0, this.reader ? this.reader.abort() : this.image.complete ? this.fail(new Error("The compression process has been aborted.")) : (this.image.onload = null, this.image.onabort())) } }]) && e(a.prototype, n), u && e(a, u), t }() });